<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Discord Webhook Manager ‚Äî Glass + Motion</title>
<style>
:root{
  --accent:#5865f2; --accent-press:#4752c4;
  --glass:#ffffff46; --glass-dark:#11182766;
  --stroke:#ffffff55; --stroke-dark:#93c5fd22;
  --text:#0e1015; --text-dark:#e6e6e6;
  --muted:#94a3b8; --muted-dark:#a3b3c6;
  --radius:16px; --shadow:0 24px 80px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 20% -10%, #6ee7ff22, transparent 60%),
    radial-gradient(1000px 600px at 120% 30%, #8b5cf633, transparent 50%),
    linear-gradient(180deg,#0a0e19,#0c1222 40%,#0a0e19);
  overflow-x:hidden;
}
body.dark{
  color:var(--text-dark);
  background:
    radial-gradient(1200px 800px at 20% -10%, #6ee7ff22, transparent 60%),
    radial-gradient(1000px 600px at 120% 30%, #8b5cf633, transparent 50%),
    linear-gradient(180deg,#090d16,#0b0f1a 40%,#090d16);
}

/* Frosted glass overlay for extra diffusion */
.glass-overlay{
  position:fixed; inset:0; pointer-events:none; z-index:-1;
  backdrop-filter: blur(18px) saturate(115%);
  -webkit-backdrop-filter: blur(18px) saturate(115%);
}

/* Animated background blobs */
.bg-blob, .bg-blob2{
  position:fixed; inset:auto; width:60vmax; height:60vmax;
  border-radius:50%; filter:blur(90px); opacity:.35; z-index:-2;
  transform:translate3d(0,0,0);
}
.bg-blob{ background:#60a5fa; right:-20vmax; bottom:-15vmax; animation:float1 22s ease-in-out infinite; }
.bg-blob2{ background:#a78bfa; left:-25vmax; top:-20vmax; animation:float2 26s ease-in-out infinite; }
@keyframes float1{ 0%,100%{ transform:translate(0,0) scale(1);} 50%{ transform:translate(-6vmax,-2vmax) scale(1.1);} }
@keyframes float2{ 0%,100%{ transform:translate(0,0) scale(1);} 50%{ transform:translate(5vmax,3vmax) scale(1.08);} }

/* Container */
.container{ max-width:980px; margin:20px auto 120px; padding:0 14px; }

/* Glass card */
.card{
  background:linear-gradient(180deg,var(--glass),transparent), linear-gradient(0deg,transparent,transparent);
  backdrop-filter: blur(14px) saturate(125%);
  -webkit-backdrop-filter: blur(14px) saturate(125%);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  padding:18px;
  margin:14px 0;
  box-shadow: var(--shadow);
}
body.dark .card{ background:linear-gradient(180deg,var(--glass-dark),transparent); border-color:var(--stroke-dark); }

/* Sticky preview wrapper */
.preview-wrapper{ position:sticky; top:10px; z-index:30; padding-top:8px; }
.preview-wrapper .card{ margin-bottom:16px; }

/* Heading */
h1{
  margin:6px 0 14px; font-weight:900; letter-spacing:.3px;
  font-size:clamp(26px,4.5vw,40px);
  color:#9ab2ff; text-shadow:0 6px 30px rgba(128,152,255,.55);
  animation:fadeUp .6s ease both .05s;
}
@keyframes fadeUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

/* Tabs */
.tabs{ display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:1; }
.tab{
  padding:10px 16px; border-radius:999px; cursor:pointer;
  border:1px solid var(--stroke); color:#e7ecff;
  background:linear-gradient(180deg,#ffffff2a,#ffffff17);
  backdrop-filter: blur(10px);
  transition:transform .12s ease, box-shadow .2s ease, background .2s ease;
}
.tab:hover{ transform:translateY(-2px); box-shadow:0 8px 30px rgba(120,140,255,.25); }
.tab.active{
  color:#fff; border-color:transparent;
  background:linear-gradient(135deg,var(--accent),#7c83ff);
  box-shadow:0 16px 40px rgba(88,101,242,.45);
}
.tab-panel{ display:none; animation:tabIn .28s ease; }
.tab-panel.active{ display:block; }
@keyframes tabIn{ from{ opacity:0; transform:translateY(6px)} to{ opacity:1; transform:translateY(0)} }

/* Inputs */
label{ display:block; margin:10px 0 6px; font-weight:800; color:#c9d4ff; }
input[type="text"], input[type="url"], input[type="color"], textarea, select{
  width:100%; padding:13px 14px; border-radius:14px;
  border:1.5px solid #e2e8f0; background:linear-gradient(180deg,#ffffffee,#ffffffdd);
  font-size:16px; color:#0b1220;
  transition:border-color .15s, box-shadow .2s, transform .06s ease;
}
input:focus, textarea:focus, select:focus{ outline:none; border-color:#93a4ff; box-shadow:0 8px 24px rgba(147,164,255,.35); }
textarea{ min-height:120px; resize:vertical; }
body.dark input,body.dark textarea,body.dark select{
  border-color:#334155; background:linear-gradient(180deg,#101421f0,#0c111df0); color:#e9eefc;
}
.helper{ color:var(--muted); font-size:12px; }
body.dark .helper{ color:var(--muted-dark);} 
.counter{ font-size:12px; color:#cbd5e1; text-align:right; }

/* Quick Actions Toolbar */
.toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
.tbtn{
  border:1px solid var(--stroke); border-radius:10px;
  padding:6px 10px; background:linear-gradient(180deg,#ffffff66,#ffffff2d);
  color:#eaf0ff; cursor:pointer;
}
.tbtn:hover{ transform:translateY(-1px); }

/* Custom file button (mobile safe) */
.fileline{ display:flex; gap:8px; align-items:center; }
.file-hidden{ position:absolute; opacity:0; width:1px; height:1px; pointer-events:none; }
.file-btn{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:linear-gradient(180deg,#ffffff70,#ffffff30); color:#eaf0ff; cursor:pointer; }
.file-name{ font-size:12px; color:#e6ecff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:160px; }

/* Preview */
.preview{
  border:1px dashed rgba(255,255,255,.35);
  border-radius:14px; padding:12px;
  background:linear-gradient(180deg,#ffffff1a,#ffffff0d);
  max-height:260px; overflow:auto; color:#ecf2ff;
}
.msg{ display:flex; gap:12px; align-items:flex-start; }
.msg .avatar{ width:44px; height:44px; border-radius:10px; object-fit:cover; box-shadow:0 10px 24px rgba(0,0,0,.3); }
.msg .name{ font-weight:900; color:#fff; }
.embed{
  border-left:4px solid #94a3ff; padding:10px 12px; margin-top:10px; border-radius:10px;
  background:linear-gradient(180deg, #ffffff15, #ffffff06);
  box-shadow:inset 0 1px 0 #ffffff20;
}

/* Floating Send button */
.fab{
  position:fixed; right:18px; bottom:18px; z-index:60;
  border:none; border-radius:999px; padding:16px 20px; font-weight:900;
  color:#fff; font-size:16px; cursor:pointer;
  background:linear-gradient(135deg,var(--accent),#7c83ff);
  box-shadow:0 24px 60px rgba(88,101,242,.45);
  display:flex; align-items:center; gap:10px;
  transition:transform .08s ease; overflow:hidden;
}
.fab:active{ transform:translateY(1px) scale(.98); }
.fab::after{
  content:""; position:absolute; inset:0; background:linear-gradient(120deg,transparent 0%,#ffffff60 30%,transparent 60%);
  transform:translateX(-120%); animation:shine 2.6s ease-in-out infinite;
}
@keyframes shine{ 0%{ transform:translateX(-120%);} 60%{ transform:translateX(140%);} 100%{ transform:translateX(140%);} }

/* Secondary button */
.btn-alt{
  background:linear-gradient(180deg,#ffffff66,#ffffff30);
  color:#eaf0ff; border:1.5px solid var(--stroke);
  padding:8px 12px; border-radius:12px; cursor:pointer;
  transition:transform .08s ease, box-shadow .15s ease, background .2s ease;
}
.btn-alt:hover{ transform:translateY(-2px); box-shadow:0 10px 30px rgba(120,140,255,.28); }

/* Embed config card */
.embed-card{
  border:1px solid var(--stroke); border-radius:14px; padding:12px; margin:12px 0;
  background:linear-gradient(180deg,#ffffff2a,#ffffff12); backdrop-filter:blur(10px);
}

/* Drag & drop */
.drop{
  border:2px dashed rgba(255,255,255,.35); border-radius:14px; padding:18px; text-align:center;
  background:linear-gradient(180deg,#ffffff15,#ffffff05);
  transition:border-color .15s, background .15s, transform .12s ease;
}
.drop.drag{ border-color:#a5b4ff; background:linear-gradient(180deg,#a5b4ff2a,#a5b4ff12); transform:scale(1.01); }
.file-grid{ display:flex; flex-wrap:wrap; gap:12px; }
.file-card{ border:1px solid var(--stroke); border-radius:12px; padding:8px; width:150px;
  display:flex; flex-direction:column; gap:8px; align-items:center;
  background:linear-gradient(180deg,#ffffff2a,#ffffff12); backdrop-filter:blur(8px);
  transition:transform .12s ease, box-shadow .15s ease; }
.file-card:hover{ transform:translateY(-2px); box-shadow:0 14px 30px rgba(0,0,0,.25); }
.file-card img{ width:100%; height:96px; object-fit:cover; border-radius:10px; }
.file-card .name{ font-size:12px; text-align:center; color:#e8eeff; }
.file-card button{ border:none; background:#ef4444; color:#fff; border-radius:9px; padding:4px 8px; cursor:pointer; }

.pills{ display:flex; flex-wrap:wrap; gap:8px; }
.pill{ display:flex; gap:8px; align-items:center; border:1px solid var(--stroke); border-radius:999px; padding:6px 12px; background:linear-gradient(180deg,#ffffff3a,#ffffff18); color:#eaf0ff; }
.pill button{ border:none; background:#ef4444; color:#fff; border-radius:999px; padding:4px 6px; cursor:pointer; }
.thumb{ width:78px; height:78px; object-fit:cover; border-radius:10px; border:1px solid var(--stroke); }

/* Toast / response / banner */
.toast{ position:fixed; right:18px; bottom:96px; background:#111827e6; color:#fff; padding:10px 14px; border-radius:12px; display:none; box-shadow:0 20px 60px rgba(0,0,0,.35); }
.response{ margin-top:10px; padding:12px; border-radius:12px; font-weight:800; display:none; }
.response.ok{ background:#16a34a1a; color:#a7f3d0; border:1px solid #16a34a55; }
.response.err{ background:#dc26261a; color:#fecaca; border:1px solid #dc262655; }
.banner{ background:#f59e0b22; color:#ffe9c2; padding:10px 12px; border-radius:12px; margin:10px 0; font-size:14px; display:none; border:1px solid #fbbf2450; }

/* --- Embed Fields UI --- */
.field-list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
.field-item {
  display:grid; grid-template-columns: 1fr 1fr auto auto; gap:8px; align-items:center;
  border:1px solid var(--stroke); border-radius:10px; padding:8px;
  background:linear-gradient(180deg,#ffffff2a,#ffffff12);
}
body.dark .field-item{ border-color:var(--stroke-dark); }
.field-item .mini { display:flex; gap:8px; align-items:center; white-space:nowrap; color:#eaf0ff; }
.field-item button { border:none; border-radius:8px; padding:6px 8px; cursor:pointer; }
.field-actions { display:flex; gap:6px; }

/* Mobile fixes / responsive grids */
@media (max-width:560px){
  .field-item{ grid-template-columns: 1fr; }
  .field-actions{ justify-content:flex-end; }
  .embed-card .twocol{ display:block !important; }
  .file-name{ max-width:120px; }
}
@media (prefers-reduced-motion: reduce){
  .bg-blob,.bg-blob2,.fab::after{ animation:none !important; }
  .tab-panel{ animation:none !important; }
}
</style>
</head>
<body>

<!-- animated blobs + frost overlay -->
<div class="bg-blob" aria-hidden="true"></div>
<div class="bg-blob2" aria-hidden="true"></div>
<div class="glass-overlay" aria-hidden="true"></div>

<button id="fabSend" class="fab">üöÄ Send</button>

<div class="container">
  <h1>Discord Webhook Manager</h1>
  <div id="banner" class="banner">‚ö†Ô∏è Running from a local file or preview app may block network requests (CORS). For live sending, open this file in a regular browser.</div>

  <!-- Sticky preview -->
  <div class="preview-wrapper">
    <div class="card">
      <strong style="color:#dbe3ff">Preview</strong>
      <div id="preview" class="preview" aria-live="polite">
        <div class="helper">Start typing to see a live preview‚Ä¶</div>
      </div>
      <div id="resp" class="response"></div>
    </div>
  </div>

  <div class="card">
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="webhook" role="tab">Webhook</div>
      <div class="tab" data-tab="message" role="tab">Message</div>
      <div class="tab" data-tab="embeds" role="tab">Embeds</div>
      <div class="tab" data-tab="mentions" role="tab">Mentions</div>
      <div class="tab" data-tab="history" role="tab">History</div>
      <div class="tab" data-tab="settings" role="tab">Settings</div>
    </div>

    <section id="tab-webhook" class="tab-panel active" role="tabpanel">
      <label for="webhookURL">Webhook URL</label>
      <input id="webhookURL" type="url" placeholder="https://discord.com/api/webhooks/..." autocomplete="url"/>
      <div class="helper">Paste the full Discord webhook URL for the channel you want to post to.</div>

      <label for="webhookExtra" style="margin-top:12px;">Additional webhooks (one per line, optional)</label>
      <textarea id="webhookExtra" placeholder="https://discord.com/api/webhooks/...\nhttps://discord.com/api/webhooks/..." style="height:90px"></textarea>
      <div class="helper">We‚Äôll broadcast to these too (throttled + rate-limit aware).</div>
    </section>

    <section id="tab-message" class="tab-panel" role="tabpanel">
      <label for="username">Username</label>
      <input id="username" type="text" placeholder="Displayed username (optional)"/>

      <label for="avatarURL">Avatar URL</label>
      <input id="avatarURL" type="url" placeholder="https://‚Ä¶ (optional)"/>

      <label for="content">Message</label>

      <!-- Quick Actions Toolbar -->
      <div class="toolbar" aria-label="Quick actions">
        <button class="tbtn" data-md="**|**"><b>B</b></button>
        <button class="tbtn" data-md="*|*"><i>I</i></button>
        <button class="tbtn" data-md="`|`"><code>code</code></button>
        <button class="tbtn" data-md="> |"><span>‚ùù</span> Quote</button>
        <button class="tbtn" data-link>Link</button>
        <button class="tbtn" data-emoji>üòÄ</button>
      </div>

      <textarea id="content" placeholder="Type your message‚Ä¶"></textarea>
      <div class="counter" id="contentCount">0 / 2000</div>

      <hr style="margin:14px 0; border:none; height:1px; background:#ffffff22">
      <strong style="color:#dbe3ff">Images via link</strong>
      <div class="helper">Add one or more image URLs to include under the message.</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px">
        <input id="imageInput" type="url" placeholder="https://example.com/image.png" style="flex:1 1 280px">
        <button class="btn-alt" id="addImage">‚ûï Add</button>
      </div>
      <div id="imageList" class="pills" style="margin-top:10px"></div>
      <div id="imageThumbs" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px"></div>

      <hr style="margin:14px 0; border:none; height:1px; background:#ffffff22">
      <strong style="color:#dbe3ff">Attachments (drag & drop)</strong>
      <div id="drop" class="drop">Drop files here or <label for="fileInput" class="btn-alt" style="display:inline-flex">browse‚Ä¶</label>
        <input id="fileInput" type="file" multiple style="display:none"></div>
      <div id="fileGrid" class="file-grid" style="margin-top:10px"></div>
    </section>

    <section id="tab-embeds" class="tab-panel" role="tabpanel">
      <button class="btn-alt" id="addEmbed">‚ûï Add Embed</button>
      <div id="embeds"></div>
      <div class="helper" style="margin-top:8px">Each embed supports Title, Description, Color, Image URL, Thumbnail URL, Footer, <b>Fields</b>, and file attachments for image/thumbnail. Max 10 embeds total (including message-level image links).</div>
    </section>

    <section id="tab-mentions" class="tab-panel" role="tabpanel">
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
        <label style="display:flex; gap:8px; align-items:center; color:#e6ecff;"><input type="checkbox" id="mentionEveryone"> @everyone</label>
        <label style="display:flex; gap:8px; align-items:center; color:#e6ecff;"><input type="checkbox" id="mentionHere"> @here</label>
      </div>
      <label>Role IDs (comma separated)</label>
      <input id="mentionRoles" type="text" placeholder="12345,67890"/>
      <label>User IDs (comma separated)</label>
      <input id="mentionUsers" type="text" placeholder="11111,22222"/>
      <div class="helper">Tips: Role/User IDs bisa diambil dari Discord (Developer Mode). Allowed mentions akan dibatasi sesuai input ini supaya aman, tidak spam semua orang.</div>
    </section>

    <section id="tab-history" class="tab-panel" role="tabpanel">
      <div id="historyList" class="helper">No history yet.</div>
    </section>

    <section id="tab-settings" class="tab-panel" role="tabpanel">
      <label style="display:flex;gap:8px;align-items:center; color:#e6ecff;">
        <input type="checkbox" id="darkToggle"/> Enable Dark Mode
      </label>
    </section>
  </div>
</div>

<div id="toast" class="toast">Copied</div>

<script>
/************ Elements ************/
const tabs=[...document.querySelectorAll('.tab')];
const panels={ webhook:tab('webhook'), message:tab('message'), embeds:tab('embeds'), mentions:tab('mentions'), history:tab('history'), settings:tab('settings') };
function tab(id){ return document.getElementById('tab-'+id); }

const webhookURL=el('webhookURL'), webhookExtra=el('webhookExtra');
const username=el('username'), avatarURL=el('avatarURL');
const content=el('content'), contentCount=el('contentCount');
const addEmbedBtn=el('addEmbed'), embedsEl=el('embeds');
const preview=el('preview'), resp=el('resp'), banner=el('banner');
const darkToggle=el('darkToggle'), fabSend=el('fabSend');
const mentionEveryone=el('mentionEveryone'), mentionHere=el('mentionHere');
const mentionRoles=el('mentionRoles'), mentionUsers=el('mentionUsers');

// Images & files
const imageInput=el('imageInput'), addImageBtn=el('addImage');
const imageList=el('imageList'), imageThumbs=el('imageThumbs');
const drop=el('drop'), fileInput=el('fileInput'), fileGrid=el('fileGrid');

// History
const historyList=el('historyList'); const HIST_KEY='discord_webhook_history_v2';

// toolbar
const toolbar=document.querySelector('.toolbar');

let embeds=[];         // {title, description, color, footer, image, thumb, fields[], _imageFile, _thumbFile}
let msgImages=[];      // url[]
let files=[];          // File[]

function el(id){ return document.getElementById(id); }

/************ Tabs ************/
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  Object.values(panels).forEach(p=>p.classList.remove('active'));
  panels[t.dataset.tab].classList.add('active');
}));

/************ Theme ************/
function applyTheme(dark){ document.body.classList.toggle('dark', dark); localStorage.setItem('webhook_dark', dark?'1':'0'); }
darkToggle?.addEventListener('change', e=> applyTheme(e.target.checked));
(function(){ const saved=localStorage.getItem('webhook_dark'); const dark=saved? saved==='1' : (matchMedia&&matchMedia('(prefers-color-scheme: dark)').matches); if(darkToggle) darkToggle.checked=dark; applyTheme(dark); })();

/************ Helpers ************/
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const validUrl=u=>{ try{ const x=new URL(u); return ['http:','https:'].includes(x.protocol);}catch{ return false; } };
function showResp(text, ok){ resp.style.display='block'; resp.textContent=text; resp.className='response '+(ok?'ok':'err'); setTimeout(()=>{ resp.style.display='none'; }, 6000); }

/************ Quick Actions Toolbar ************/
toolbar.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  if(btn.dataset.md){ wrapSelection(content, ...btn.dataset.md.split('|')); return updatePreviewCounts(); }
  if(btn.dataset.link){ const sel=getSel(content)||'text'; wrapSelection(content,'[','](https://)'); if(sel===''){ placeCaret(content, content.selectionStart-1); } return updatePreviewCounts(); }
  if(btn.dataset.emoji){ insertAtCursor(content,' üòÄ '); return updatePreviewCounts(); }
});
function getSel(t){ return t.value.substring(t.selectionStart,t.selectionEnd); }
function wrapSelection(t, pre, post){ const s=t.selectionStart, e=t.selectionEnd; const val=t.value; const sel=val.slice(s,e); const out=val.slice(0,s)+pre+sel+post+val.slice(e); t.value=out; const offset=pre.length; t.setSelectionRange(s+offset, e+offset); t.focus(); }
function insertAtCursor(t, text){ const s=t.selectionStart, e=t.selectionEnd; t.value=t.value.slice(0,s)+text+t.value.slice(e); const p=s+text.length; t.setSelectionRange(p,p); t.focus(); }
function placeCaret(t, pos){ t.setSelectionRange(pos,pos); t.focus(); }

/************ Preview ************/
function renderPreview(){
  const name=esc(username.value||'Webhook');
  const avatar=esc(avatarURL.value||'https://cdn.discordapp.com/embed/avatars/0.png');
  const msg=esc(content.value||'');
  let html=`<div class="msg"><img class="avatar" src="${avatar}" alt="avatar"/><div><div class="name">${name}</div><div style="margin-top:6px;white-space:pre-wrap">${msg}</div></div></div>`;
  if(msgImages.length){
    html += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">` +
      msgImages.map(u=>`<img class="thumb" src="${esc(u)}" alt="image"/>`).join('') + `</div>`;
  }
  embeds.forEach(e=>{
    const color=e.color||'#5865f2';
    const imgLocal = e._imageFile ? URL.createObjectURL(e._imageFile) : null;
    const thumbLocal = e._thumbFile ? URL.createObjectURL(e._thumbFile) : null;
    html+=`<div class="embed" style="border-color:${esc(color)}">`+
      (e.title?`<div style="font-weight:800">${esc(e.title)}</div>`:'')+
      (e.description?`<div style="margin-top:6px;white-space:pre-wrap">${esc(e.description)}</div>`:'')+
      ((imgLocal||e.image)?`<div style="margin-top:8px"><img src="${esc(imgLocal||e.image)}" class="thumb" style="width:auto;height:120px" alt="embed image"></div>`:'')+
      ((thumbLocal||e.thumb)?`<div style="margin-top:8px"><img src="${esc(thumbLocal||e.thumb)}" class="thumb" alt="thumbnail"></div>`:'')+
      (Array.isArray(e.fields)&&e.fields.length? `<div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px">${e.fields.map(f=>`<div style="background:#ffffff10;border:1px solid #ffffff22;border-radius:8px;padding:6px"><div style="font-weight:800">${esc(f.name||'')}</div><div style="white-space:pre-wrap">${esc(f.value||'')}</div></div>`).join('')}</div>`:'')+
      (e.footer?`<div style="margin-top:8px;font-size:12px;opacity:.8">${esc(e.footer)}</div>`:'')+
      `</div>`;
  });
  preview.innerHTML=html;
}
function updatePreviewCounts(){ renderPreview(); const n=(content.value||'').length; contentCount.textContent=`${n} / 2000`; contentCount.style.color = n>2000 ? '#fecaca' : '#cbd5e1'; }
[username,avatarURL,content].forEach(el=> el.addEventListener('input', updatePreviewCounts));

/************ Images via link ************/
function renderImages(){
  imageList.innerHTML = msgImages.map((u,i)=>`<span class="pill"><span>${esc(u)}</span><button data-rm="${i}">√ó</button></span>`).join('');
  imageList.querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click',()=>{ msgImages.splice(parseInt(b.dataset.rm,10),1); renderImages(); updatePreviewCounts(); }));
  imageThumbs.innerHTML = msgImages.map(u=>`<img class="thumb" src="${esc(u)}" alt="img">`).join('');
}
addImageBtn?.addEventListener('click',()=>{ const u=imageInput.value.trim(); if(!u) return; if(!validUrl(u)) return showResp('Invalid image URL', false); if(msgImages.length>=10) return showResp('Max 10 images', false); msgImages.push(u); imageInput.value=''; renderImages(); updatePreviewCounts(); });

/************ Drag & drop files ************/
function renderFiles(){
  fileGrid.innerHTML = files.map((f,i)=>{
    const isImg = /^image\//.test(f.type);
    const url = isImg ? URL.createObjectURL(f) : '';
    return `<div class="file-card">${isImg?`<img src="${url}" alt="${esc(f.name)}"/>`:`<div class="helper" style="height:96px;display:flex;align-items:center;justify-content:center;">${esc(f.type||'file')}</div>`}<div class="name">${esc(f.name)}</div><button data-rm="${i}">Remove</button></div>`;
  }).join('');
  fileGrid.querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click',()=>{ files.splice(parseInt(b.dataset.rm,10),1); renderFiles(); }));
}
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev,e=>{ e.preventDefault(); drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev,e=>{ e.preventDefault(); if(ev==='drop'){ files.push(...Array.from(e.dataTransfer.files||[])); renderFiles(); } drop.classList.remove('drag'); }));
fileInput.addEventListener('change',()=>{ files.push(...Array.from(fileInput.files||[])); fileInput.value=''; renderFiles(); });

/************ Embeds UI + Fields + File attachments ************/
function filenameFromInput(inp){ return inp?.files?.[0]?.name || ''; }

function renderFieldRow(embedIndex, fieldIndex, container){
  const f = embeds[embedIndex].fields[fieldIndex];
  const row = document.createElement('div');
  row.className = 'field-item';
  row.innerHTML = `
    <input type="text" placeholder="Field name" value="${esc(f.name||'')}">
    <input type="text" placeholder="Field value" value="${esc(f.value||'')}">
    <div class="mini">
      <label><input type="checkbox" ${f.inline?'checked':''}> inline</label>
      <button class="btn-alt" data-clear>üßπ</button>
    </div>
    <div class="field-actions">
      <button class="btn-alt" data-up>‚Üë</button>
      <button class="btn-alt" data-down>‚Üì</button>
      <button class="btn-alt" data-del>‚úñ</button>
    </div>
  `;
  const [nameEl, valueEl] = row.querySelectorAll('input[type="text"]');
  const inlineEl = row.querySelector('input[type="checkbox"]');

  nameEl.addEventListener('input', ()=>{ embeds[embedIndex].fields[fieldIndex].name = nameEl.value; updatePreviewCounts(); });
  valueEl.addEventListener('input', ()=>{ embeds[embedIndex].fields[fieldIndex].value = valueEl.value; updatePreviewCounts(); });
  inlineEl.addEventListener('change', ()=>{ embeds[embedIndex].fields[fieldIndex].inline = inlineEl.checked; updatePreviewCounts(); });
  row.querySelector('[data-clear]').addEventListener('click', ()=>{ embeds[embedIndex].fields[fieldIndex].name=''; embeds[embedIndex].fields[fieldIndex].value=''; nameEl.value=''; valueEl.value=''; updatePreviewCounts(); });

  row.querySelector('[data-up]').addEventListener('click', ()=>{
    if(fieldIndex<=0) return; const arr=embeds[embedIndex].fields;
    [arr[fieldIndex-1], arr[fieldIndex]] = [arr[fieldIndex], arr[fieldIndex-1]];
    renderFields(embedIndex, container); updatePreviewCounts();
  });
  row.querySelector('[data-down]').addEventListener('click', ()=>{
    const arr=embeds[embedIndex].fields; if(fieldIndex>=arr.length-1) return;
    [arr[fieldIndex+1], arr[fieldIndex]] = [arr[fieldIndex], arr[fieldIndex+1]];
    renderFields(embedIndex, container); updatePreviewCounts();
  });
  row.querySelector('[data-del]').addEventListener('click', ()=>{
    embeds[embedIndex].fields.splice(fieldIndex,1); renderFields(embedIndex, container); updatePreviewCounts();
  });
  container.appendChild(row);
}
function renderFields(embedIndex, container){ container.innerHTML = ''; embeds[embedIndex].fields.forEach((_,i)=> renderFieldRow(embedIndex, i, container)); }

function addEmbed(pre={}){
  const data={
    title:pre.title||'',
    description:pre.description||'',
    color:pre.color||'#5865f2',
    footer:pre.footer||'',
    image:pre.image||'',
    thumb:pre.thumb||'',
    fields: Array.isArray(pre.fields)? pre.fields.map(f=>({name:f.name||'', value:f.value||'', inline:!!f.inline})) : [],
    _imageFile:null, _thumbFile:null
  };
  embeds.push(data); const idx=embeds.length-1;

  const wrap=document.createElement('div'); wrap.className='embed-card';
  wrap.innerHTML=`
    <label>Title</label>
    <input type="text" value="${esc(data.title)}" data-i="${idx}" data-f="title">

    <label>Description</label>
    <textarea data-i="${idx}" data-f="description">${esc(data.description)}</textarea>

    <div class="twocol" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <div>
        <label>Color</label>
        <input type="color" value="${data.color}" data-i="${idx}" data-f="color">
      </div>
      <div>
        <label>Footer</label>
        <input type="text" placeholder="Footer text" value="${esc(data.footer)}" data-i="${idx}" data-f="footer">
      </div>
    </div>

    <label>Image URL (optional)</label>
    <input type="url" placeholder="https://‚Ä¶" value="${esc(data.image)}" data-i="${idx}" data-f="image">

    <label>Thumbnail URL (optional)</label>
    <input type="url" placeholder="https://‚Ä¶" value="${esc(data.thumb)}" data-i="${idx}" data-f="thumb">

    <div class="twocol" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px">
      <div>
        <label>Embed Image (file)</label>
        <input id="imgfile-${idx}" class="file-hidden" type="file" accept="image/*" data-i="${idx}" data-fx="imgfile">
        <div class="fileline"><label class="file-btn" for="imgfile-${idx}">üìé Choose File</label><span class="file-name" data-fn-img></span></div>
        <div class="helper">If set, embed image uses <code>attachment://filename</code>.</div>
      </div>
      <div>
        <label>Embed Thumbnail (file)</label>
        <input id="thumbfile-${idx}" class="file-hidden" type="file" accept="image/*" data-i="${idx}" data-fx="thumbfile">
        <div class="fileline"><label class="file-btn" for="thumbfile-${idx}">üìé Choose File</label><span class="file-name" data-fn-th></span></div>
        <div class="helper">If set, thumbnail uses <code>attachment://filename</code>.</div>
      </div>
    </div>

    <hr style="margin:10px 0; border:none; height:1px; background:#ffffff22">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <strong style="color:#dbe3ff">Fields</strong>
      <div style="display:flex;gap:8px">
        <button class="btn-alt" data-addfield="${idx}">‚ûï Add Field</button>
        <button class="btn-alt" data-clearall="${idx}">üßπ Clear All</button>
      </div>
    </div>
    <div class="field-list" data-fl="${idx}"></div>

    <div style="margin-top:8px">
      <button class="btn-alt" data-remove="${idx}">‚ùå Remove Embed</button>
    </div>
  `;
  embedsEl.appendChild(wrap);

  wrap.querySelectorAll('input[type="text"],input[type="url"],input[type="color"],textarea').forEach(inp=>{
    if(inp.dataset.f){ inp.addEventListener('input', ()=>{ embeds[inp.dataset.i][inp.dataset.f]=inp.value; updatePreviewCounts(); }); }
  });

  // File inputs
  wrap.querySelectorAll('input[type="file"][data-fx]').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const i=parseInt(inp.dataset.i,10);
      const f=(inp.files && inp.files[0])? inp.files[0]: null;
      if(inp.dataset.fx==='imgfile'){ embeds[i]._imageFile=f; wrap.querySelector('[data-fn-img]').textContent=filenameFromInput(inp); }
      if(inp.dataset.fx==='thumbfile'){ embeds[i]._thumbFile=f; wrap.querySelector('[data-fn-th]').textContent=filenameFromInput(inp); }
      updatePreviewCounts();
    });
  });

  // Fields UI
  const listEl = wrap.querySelector('[data-fl]');
  renderFields(idx, listEl);
  wrap.querySelector('[data-addfield]').addEventListener('click', ()=>{ embeds[idx].fields.push({name:'',value:'',inline:false}); renderFields(idx, listEl); updatePreviewCounts(); });
  wrap.querySelector('[data-clearall]').addEventListener('click', ()=>{ embeds[idx].fields=[]; renderFields(idx, listEl); updatePreviewCounts(); });

  // Remove embed
  wrap.querySelector('[data-remove]').addEventListener('click', ()=>{ embeds.splice(idx,1); wrap.remove(); updatePreviewCounts(); });

  updatePreviewCounts();
}
addEmbedBtn?.addEventListener('click', ()=> addEmbed());

/************ Build payload + attachments ************/
function parseIds(s){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); }
function filenameSafe(name){ return (name||'file').replace(/[^\w\-.]+/g,'_').slice(0,80) || 'file'; }

function buildEmbedsAndAttachments(){
  const built=[]; const attachments=[];
  embeds.forEach((e,i)=>{
    const out={};
    if(e.title) out.title=e.title;
    if(e.description) out.description=e.description;
    if(e.color) out.color=parseInt(e.color.replace('#',''),16);
    if(e.footer) out.footer={text:e.footer};
    if(Array.isArray(e.fields)&&e.fields.length){
      out.fields=e.fields.map(f=>({name:f.name||'', value:f.value||'', inline:!!f.inline})).filter(f=>(f.name||'').trim()||(f.value||'').trim());
    }
    if(e._imageFile){ const fname=filenameSafe(`embed${i+1}-image-${e._imageFile.name||'img'}`); attachments.push({file:e._imageFile,name:fname}); out.image={url:`attachment://${fname}`}; }
    else if((e.image||'').trim()){ out.image={url:e.image.trim()}; }
    if(e._thumbFile){ const fname=filenameSafe(`embed${i+1}-thumb-${e._thumbFile.name||'thumb'}`); attachments.push({file:e._thumbFile,name:fname}); out.thumbnail={url:`attachment://${fname}`}; }
    else if((e.thumb||'').trim()){ out.thumbnail={url:e.thumb.trim()}; }
    if(Object.keys(out).length) built.push(out);
  });
  msgImages.forEach(u=>{ if(built.length<10) built.push({ image:{ url:u } }); });
  return { embeds: built.slice(0,10), attachments };
}
function buildAllowedMentions(){ const roles=parseIds(mentionRoles.value), users=parseIds(mentionUsers.value); const parse=[]; if(mentionEveryone?.checked||mentionHere?.checked) parse.push('everyone'); return { parse, roles, users }; }
function buildPayloadAndAttachments(){
  const p={}; let c=(content.value||'').trim();
  if(mentionEveryone?.checked) c=`@everyone ${c}`; if(mentionHere?.checked) c=`@here ${c}`;
  if(c) p.content=c; if(username.value) p.username=username.value; if(avatarURL.value) p.avatar_url=avatarURL.value;
  const {embeds: em, attachments}=buildEmbedsAndAttachments(); if(em.length) p.embeds=em;
  const am=buildAllowedMentions(); if(am.parse.length||am.roles.length||am.users.length) p.allowed_mentions=am;
  return { payload:p, attachments };
}

/************ History ************/
function pushHistory(entry){ try{ const list=getHistory(); list.unshift(entry); while(list.length>50) list.pop(); localStorage.setItem(HIST_KEY, JSON.stringify(list)); renderHistory(); }catch{} }
function getHistory(){ try{ return JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); }catch{ return []; } }
function renderHistory(){
  const list=getHistory();
  if(!list.length){ historyList.textContent='No history yet.'; return; }
  historyList.innerHTML = list.map((h,i)=>`<div class="file-card" style="width:auto;align-items:stretch"><div><strong>#${i+1}</strong> ‚Äî ${new Date(h.ts).toLocaleString()}<div class="helper">${esc(h.preview||'')}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn-alt" data-load="${i}">Load</button><button class="btn-alt" data-resend="${i}">Re-send</button></div></div>`).join('');
  historyList.querySelectorAll('[data-load]').forEach(b=> b.addEventListener('click',()=>{
    const h=getHistory()[parseInt(b.dataset.load,10)]; if(!h) return;
    username.value=h.payload.username||''; avatarURL.value=h.payload.avatar_url||''; content.value=h.payload.content||'';
    embeds=(h.payload.embeds||[]).map(e=>({ title:e.title||'', description:e.description||'', color:e.color?('#'+(e.color>>>0).toString(16).padStart(6,'0')):'#5865f2', footer:e.footer?.text||'', image:e.image?.url||'', thumb:e.thumbnail?.url||'', fields:Array.isArray(e.fields)? e.fields.map(f=>({name:f.name||'', value:f.value||'', inline:!!f.inline})) : [], _imageFile:null, _thumbFile:null }));
    embedsEl.innerHTML=''; embeds.forEach(e=> addEmbed(e)); updatePreviewCounts();
    tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab==='message')); Object.values(panels).forEach(p=> p.classList.remove('active')); panels.message.classList.add('active');
  }));
  historyList.querySelectorAll('[data-resend]').forEach(b=> b.addEventListener('click',async()=>{
    const h=getHistory()[parseInt(b.dataset.resend,10)]; if(!h) return; const w=h.webhook||webhookURL.value.trim();
    try{ const r=await fetch(w,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(h.payload)}); if(r.ok) showResp('Re-sent ‚úÖ', true); else showResp('Re-send failed', false);}catch(e){ showResp('Network error: '+e.message,false); }
  }));
}

/************ Multi-webhook send ************/
function parseWebhookList(){ const list=[]; const main=webhookURL.value.trim(); if(main) list.push(main); (webhookExtra.value||'').split('\n').map(s=>s.trim()).filter(Boolean).forEach(u=> list.push(u)); return [...new Set(list)]; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function sendToWebhook(url, payloadObj, fileList, embedAttachments){
  const hasAnyFile=(fileList&&fileList.length)||(embedAttachments&&embedAttachments.length); let r;
  if(hasAnyFile){
    const form=new FormData(); form.append('payload_json', JSON.stringify(payloadObj));
    (fileList||[]).forEach(f=> form.append('file', f));
    (embedAttachments||[]).forEach(att=> att?.file && form.append('file', att.file, att.name));
    r=await fetch(url,{ method:'POST', body: form });
  } else {
    r=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payloadObj)});
  }
  if(r.status===429){ let retry=1000; try{ const j=await r.json(); if(j.retry_after) retry=Math.ceil(Number(j.retry_after)*1000);}catch{} await sleep(retry); return sendToWebhook(url,payloadObj,fileList,embedAttachments); }
  return r;
}
async function sendPayload(){
  const urls=parseWebhookList(); if(!urls.length) return showResp('Enter at least one webhook URL', false);
  const { payload, attachments } = buildPayloadAndAttachments();
  const hasFiles=files.length>0;
  if(!hasFiles && !attachments.length && !payload.content && !(payload.embeds&&payload.embeds.length))
    return showResp('Add message or image/embed before sending.', false);

  let okCount=0, failCount=0;
  for(let i=0;i<urls.length;i++){
    try{
      const r=await sendToWebhook(urls[i], payload, files, attachments);
      const txt=await r.text(); let parsed; try{ parsed=JSON.parse(txt);}catch{}
      if(r.ok){ okCount++; pushHistory({ ts: Date.now(), webhook:urls[i], payload, preview:(payload.content||'') }); }
      else { failCount++; console.warn('Error', parsed?.message||r.status, parsed?.errors||txt); }
    }catch(e){ failCount++; console.error('Network error:',e); }
    if(i<urls.length-1) await sleep(250);
  }
  if(okCount && !failCount){ showResp(`Sent ‚úÖ (${okCount}/${urls.length})`, true); files=[]; renderFiles(); }
  else if(okCount && failCount){ showResp(`Partial: ${okCount} sent, ${failCount} failed`, false); }
  else { showResp(`All failed (${failCount})`, false); }
}
fabSend?.addEventListener('click', sendPayload);

/************ Init ************/
if(location.protocol==='file:'){ banner.style.display='block'; }
updatePreviewCounts(); renderImages(); renderFiles(); renderHistory();
</script>
</body>
</html>
