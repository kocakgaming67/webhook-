<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Discord Webhook Manager — Touch First + Files/History/Mentions</title>
<style>
:root{
  --accent:#5865f2; --accent-press:#4752c4;
  --glass:#ffffff24; --stroke:#ffffff30;
  --text:#e8eeff; --muted:#cbd5e1;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 560px at 15% -10%, #6ee7ff18, transparent 60%),
    radial-gradient(760px 500px at 120% 30%, #8b5cf61a, transparent 50%),
    linear-gradient(180deg,#0a0f19,#0b1120 40%,#0a0f19);
  overflow-x:hidden;
}
.container{ max-width:980px; margin:18px auto 120px; padding:0 14px; }

/* animated blobs */
.bg-blob,.bg-blob2{ position:fixed; width:40vmax; height:40vmax; border-radius:50%; filter:blur(60px); opacity:.2; z-index:-2; }
.bg-blob{ background:#60a5fa; right:-18vmax; bottom:-14vmax; animation:float1 28s ease-in-out infinite; }
.bg-blob2{ background:#a78bfa; left:-22vmax; top:-16vmax; animation:float2 32s ease-in-out infinite; }
@keyframes float1{0%,100%{transform:translate(0,0)}50%{transform:translate(-4vmax,-2vmax)}}
@keyframes float2{0%,100%{transform:translate(0,0)}50%{transform:translate(3vmax,2vmax)}}
@media (prefers-reduced-motion: reduce){ .bg-blob,.bg-blob2{animation:none}}

/* glass card */
.card{
  background:linear-gradient(180deg,var(--glass),transparent);
  backdrop-filter: blur(6px) saturate(120%);
  -webkit-backdrop-filter: blur(6px) saturate(120%);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  padding:16px; margin:12px 0;
  box-shadow: 0 6px 24px rgba(0,0,0,.22);
}

/* Sticky preview */
.preview-wrapper{ position:sticky; top:10px; z-index:30; }
h1{ margin:4px 0 12px; font-weight:900; letter-spacing:.3px; font-size:clamp(26px,4.5vw,40px); color:#b8c6ff; }

/* Tabs + history icon */
.tabs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
.tabs-grow{ flex:1 1 auto; display:flex; gap:10px; flex-wrap:wrap; }
.tab{
  padding:10px 16px; border-radius:999px; cursor:pointer;
  border:1px solid var(--stroke); color:#e7ecff;
  background:linear-gradient(180deg,#ffffff22,#ffffff12);
  transition:transform .08s ease, box-shadow .15s ease, background .15s ease;
}
.tab:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(120,140,255,.18); }
.tab.active{ color:#fff; border-color:transparent; background:linear-gradient(135deg,var(--accent),#7c83ff); box-shadow:0 10px 26px rgba(88,101,242,.28); }
.tab-panel{ display:none; margin-top:12px; }
.tab-panel.active{ display:block; }
.tab-panel > :first-child{ margin-top:6px; }

/* tiny icon button (history clock) */
.tab-icon{
  margin-left:auto; display:inline-flex; align-items:center; justify-content:center;
  width:42px; height:42px; border-radius:999px; cursor:pointer;
  border:1px solid var(--stroke);
  background:linear-gradient(180deg,#ffffff26,#ffffff10);
  transition:transform .08s ease, box-shadow .15s ease;
}
.tab-icon:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(120,140,255,.18); }
.tab-icon svg{ width:20px; height:20px; stroke:#e8eeff; }

/* Inputs */
label{ display:block; margin:10px 0 6px; font-weight:800; color:#dfe6ff; }
input[type="text"],input[type="url"],input[type="color"],textarea,select{
  width:100%; padding:12px 14px; border-radius:14px;
  border:1.5px solid #334155; background:linear-gradient(180deg,#0f1421,#0b111c);
  color:#e9eefc; font-size:16px; transition:border-color .15s, box-shadow .15s;
}
input:focus,textarea:focus,select:focus{ outline:none; border-color:#8593ff; box-shadow:0 6px 16px rgba(147,164,255,.18); }
textarea{ min-height:110px; resize:vertical; }
.counter{ font-size:12px; color:var(--muted); text-align:right; }

/* Toolbar */
.toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
.tbtn{ border:1px solid var(--stroke); border-radius:10px; padding:6px 10px; background:linear-gradient(180deg,#ffffff30,#ffffff17); color:#eaf0ff; cursor:pointer; }
.tbtn:hover{ transform:translateY(-1px); }

/* Preview */
.preview{
  border:1px dashed rgba(255,255,255,.24);
  border-radius:14px; padding:12px;
  background:linear-gradient(180deg,#ffffff10,#ffffff06);
  max-height:230px; overflow:auto; color:#ecf2ff;
}
.msg{ display:flex; gap:12px; align-items:flex-start; }
.avatar{ width:44px; height:44px; border-radius:10px; object-fit:cover; }
.name{ font-weight:900; color:#fff; }
.embed{ border-left:4px solid #94a3ff; padding:10px 12px; margin-top:10px; border-radius:10px; background:linear-gradient(180deg,#ffffff10,#ffffff06); }

/* Floating actions (Send idle animation) */
.fab{
  position:fixed; right:18px; bottom:18px; z-index:60;
  border:none; border-radius:999px; padding:16px 22px; font-weight:900;
  color:#fff; font-size:16px; cursor:pointer;
  background:linear-gradient(135deg,var(--accent),#7c83ff);
  box-shadow:0 16px 42px rgba(88,101,242,.32);
  transition:transform .08s ease;
  animation:fabbreathe 2.6s ease-in-out infinite;
}
.fab:active{ transform:translateY(1px) scale(.985); }
.fab::after{
  content:""; position:absolute; inset:-6px; border-radius:inherit;
  border:2px solid rgba(124,131,255,.35); pointer-events:none;
  transform:scale(.98); opacity:.55; animation:fabpulse 2.6s ease-in-out infinite;
}
@keyframes fabbreathe{ 0%,100%{box-shadow:0 16px 42px rgba(88,101,242,.30); transform:translateY(0) scale(1)} 50%{box-shadow:0 22px 58px rgba(88,101,242,.46); transform:translateY(-1px) scale(1.03)} }
@keyframes fabpulse{ 0%,100%{transform:scale(.98);opacity:.55} 50%{transform:scale(1.08);opacity:.15} }
@media (prefers-reduced-motion: reduce){ .fab,.fab::after{animation:none}}

/* Clear button next to Send */
.fab-clear{
  position:fixed; right:140px; bottom:18px; z-index:59;
  border:none; border-radius:999px; padding:14px 18px; font-weight:800;
  color:#e6ebff; font-size:14px; cursor:pointer;
  background:linear-gradient(135deg,#374151,#1f2937);
  border:1px solid #475569;
  box-shadow:0 12px 30px rgba(15,23,42,.4);
  transition:transform .08s ease, box-shadow .2s ease;
}
.fab-clear:hover{ transform:translateY(-1px); box-shadow:0 16px 38px rgba(15,23,42,.55); }
.fab-clear:active{ transform:translateY(1px); }

/* Buttons */
.btn-alt{ background:linear-gradient(180deg,#ffffff30,#ffffff15); color:#eaf0ff; border:1.5px solid var(--stroke); padding:10px 12px; border-radius:12px; cursor:pointer; }
.btn-alt:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(120,140,255,.2); }
.btn-wide{ display:block; width:100%; text-align:center; }

/* Embed editor */
.embed-card{ border:1px solid var(--stroke); border-radius:14px; padding:12px; margin:12px 0; background:linear-gradient(180deg,#ffffff1e,#ffffff0d); }

/* DnD Files */
.drop{ border:2px dashed rgba(255,255,255,.24); border-radius:14px; padding:18px; text-align:center; background:linear-gradient(180deg,#ffffff10,#ffffff06); }
.drop.drag{ border-color:#a5b4ff; background:linear-gradient(180deg,#a5b4ff20,#a5b4ff10); }
.file-grid{ display:flex; flex-wrap:wrap; gap:12px; }
.file-card{ border:1px solid var(--stroke); border-radius:12px; padding:8px; width:150px; display:flex; flex-direction:column; gap:8px; align-items:center; background:linear-gradient(180deg,#ffffff1e,#ffffff0c); }
.file-card img{ width:100%; height:96px; object-fit:cover; border-radius:10px; }
.file-card .name{ font-size:12px; text-align:center; color:#e8eeff; }
.file-card button{ border:none; background:#ef4444; color:#fff; border-radius:9px; padding:4px 8px; cursor:pointer; }

/* Pills for message images */
.pills{ display:flex; flex-wrap:wrap; gap:8px; }
.pill{ display:flex; gap:8px; align-items:center; border:1px solid var(--stroke); border-radius:999px; padding:6px 12px; background:linear-gradient(180deg,#ffffff26,#ffffff12); color:#eaf0ff; }
.pill button{ border:none; background:#ef4444; color:#fff; border-radius:999px; padding:4px 6px; cursor:pointer; }
.thumb{ width:78px; height:78px; object-fit:cover; border-radius:10px; border:1px solid var(--stroke); }

/* Response */
.response{ margin-top:10px; padding:12px; border-radius:12px; font-weight:800; display:none; }
.response.ok{ background:#0f3d1f; color:#b2f5c9; border:1px solid #1e8548; }
.response.err{ background:#3d1414; color:#ffcaca; border:1px solid #8c2a2a; }

/* Fields UI */
.field-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
.field-item{ display:grid; grid-template-columns:1fr 1fr auto auto; gap:8px; align-items:center; border:1px solid var(--stroke); border-radius:10px; padding:8px; background:linear-gradient(180deg,#ffffff1e,#ffffff0c); }
.field-item .mini{ display:flex; gap:8px; align-items:center; white-space:nowrap; color:#eaf0ff; }
.field-actions{ display:flex; gap:6px; }
.field-item button{ border:none; border-radius:8px; padding:6px 8px; cursor:pointer; }

/* History modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(5,8,15,.55); display:none; z-index:70; }
.modal{ position:fixed; inset:auto 0 0 0; margin:auto; top:8%; max-width:840px; width:calc(100% - 28px); z-index:80; display:none; }
.modal .card{ max-height:70vh; overflow:auto; }
#historyList{ margin-top:8px; }
#historyList .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; background:linear-gradient(180deg,#ffffff1e,#ffffff0d); margin:8px 0; }
#historyList .acts{ display:flex; gap:8px; }

/* spacing polish */
#tab-embeds #addEmbed.btn-wide{ width:100%; margin-top:10px; margin-bottom:8px; }
#embeds{ margin-top:10px; }

@media (max-width:560px){
  .field-item{ grid-template-columns:1fr; }
  .field-actions{ justify-content:flex-end; }
  .embed-card .twocol{ display:block !important; }
  .fab-clear{ right:130px; }
}
</style>
</head>
<body>

<div class="bg-blob" aria-hidden="true"></div>
<div class="bg-blob2" aria-hidden="true"></div>

<!-- Floating actions -->
<button id="fabClear" class="fab-clear" title="Clear form">Clear</button>
<button id="fabSend" class="fab" title="Send">Send</button>

<div class="container">
  <h1>Discord Webhook Manager</h1>

  <!-- Sticky preview -->
  <div class="preview-wrapper">
    <div class="card">
      <strong>Preview</strong>
      <div id="preview" class="preview" aria-live="polite"></div>
      <div id="resp" class="response"></div>
    </div>
  </div>

  <div class="card">
    <div class="tabs" role="tablist">
      <div class="tabs-grow">
        <div class="tab active" data-tab="webhook" role="tab">Webhook</div>
        <div class="tab" data-tab="message" role="tab">Message</div>
        <div class="tab" data-tab="embeds" role="tab">Embeds</div>
      </div>
      <!-- history icon -->
      <button id="historyBtn" class="tab-icon" title="History" aria-label="History">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 3-6.7" stroke="currentColor" />
          <path d="M3 3v6h6" stroke="currentColor" />
          <path d="M12 7v5l3 2" stroke="currentColor" />
        </svg>
      </button>
    </div>

    <!-- Webhook -->
    <section id="tab-webhook" class="tab-panel active" role="tabpanel">
      <label for="webhookURL">Webhook URL</label>
      <input id="webhookURL" type="url" placeholder="https://discord.com/api/webhooks/..."/>

      <label for="webhookExtra" style="margin-top:12px;">Additional webhooks (one per line)</label>
      <textarea id="webhookExtra" placeholder="" style="height:90px"></textarea>
    </section>

    <!-- Message -->
    <section id="tab-message" class="tab-panel" role="tabpanel">
      <label for="username">Username</label>
      <input id="username" type="text" placeholder=""/>

      <label for="avatarURL">Avatar URL</label>
      <input id="avatarURL" type="url" placeholder="https://…"/>

      <label for="content">Message</label>
      <div class="toolbar">
        <button class="tbtn" data-md="**|**">Bold</button>
        <button class="tbtn" data-md="*|*">Italic</button>
        <button class="tbtn" data-md="`|`">Code</button>
        <button class="tbtn" data-md="> |">Quote</button>
        <button class="tbtn" data-link>Link</button>
      </div>
      <textarea id="content" placeholder=""></textarea>
      <div class="counter" id="contentCount">0 / 2000</div>

      <hr style="margin:14px 0; border:none; height:1px; background:#ffffff22">
      <strong>Mentions</strong>
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:8px 0;">
        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="mentionEveryone"> @everyone</label>
        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="mentionHere"> @here</label>
      </div>
      <label>Role IDs (comma separated)</label>
      <input id="mentionRoles" type="text" placeholder=""/>
      <label>User IDs (comma separated)</label>
      <input id="mentionUsers" type="text" placeholder=""/>

      <hr style="margin:14px 0; border:none; height:1px; background:#ffffff22">
      <strong>Images via link</strong>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px">
        <input id="imageInput" type="url" placeholder="https://example.com/image.png" style="flex:1 1 280px">
        <button class="btn-alt" id="addImage">Add</button>
      </div>
      <div id="imageList" class="pills" style="margin-top:10px"></div>
      <div id="imageThumbs" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px"></div>

      <hr style="margin:14px 0; border:none; height:1px; background:#ffffff22">
      <strong>Attachments</strong>
      <div id="drop" class="drop">Drop files here or <label for="fileInput" class="btn-alt" style="display:inline-flex">browse…</label>
        <!-- accept ANY file type -->
        <input id="fileInput" type="file" multiple style="display:none">
      </div>
      <div id="fileGrid" class="file-grid" style="margin-top:10px"></div>
    </section>

    <!-- Embeds -->
    <section id="tab-embeds" class="tab-panel" role="tabpanel">
      <button class="btn-alt btn-wide" id="addEmbed">Add Embed</button>
      <div id="embeds"></div>
    </section>
  </div>
</div>

<!-- History Modal -->
<div id="historyBackdrop" class="modal-backdrop"></div>
<div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <strong id="historyTitle">History</strong>
      <div style="display:flex;gap:8px;">
        <button id="closeHistory" class="btn-alt">Close</button>
        <button id="clearHistory" class="btn-alt" title="Clear history">Clear</button>
      </div>
    </div>
    <div id="historyList">No history yet.</div>
  </div>
</div>

<script>
/******** elements *********/
const tabs=[...document.querySelectorAll('.tab')];
const panels={ webhook:gid('tab-webhook'), message:gid('tab-message'), embeds:gid('tab-embeds') };
const webhookURL=gid('webhookURL'), webhookExtra=gid('webhookExtra');
const username=gid('username'), avatarURL=gid('avatarURL');
const content=gid('content'), contentCount=gid('contentCount');
const addEmbedBtn=gid('addEmbed'), embedsEl=gid('embeds');
const preview=gid('preview'), resp=gid('resp'), fabSend=gid('fabSend'), fabClear=gid('fabClear');
const mentionEveryone=gid('mentionEveryone'), mentionHere=gid('mentionHere');
const mentionRoles=gid('mentionRoles'), mentionUsers=gid('mentionUsers');
const imageInput=gid('imageInput'), addImageBtn=gid('addImage');
const imageList=gid('imageList'), imageThumbs=gid('imageThumbs');
const drop=gid('drop'), fileInput=gid('fileInput'), fileGrid=gid('fileGrid');
const historyList=gid('historyList'); const toolbar=document.querySelector('.toolbar');
const historyBtn=gid('historyBtn'), historyModal=gid('historyModal'), historyBackdrop=gid('historyBackdrop');
const closeHistory=gid('closeHistory'), clearHistory=gid('clearHistory');
function gid(id){ return document.getElementById(id); }

/******** state *********/
let embeds=[]; let msgImages=[]; let files=[];
const HIST_KEY='discord_webhook_history_v5'; // de-duped

/******** tabs *********/
tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); Object.values(panels).forEach(p=>p.classList.remove('active')); panels[t.dataset.tab].classList.add('active'); }));

/******** helpers *********/
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const validUrl=u=>{ try{ const x=new URL(u); return ['http:','https:'].includes(x.protocol);}catch{ return false; } };
function showResp(text, ok){ resp.style.display='block'; resp.textContent=text; resp.className='response '+(ok?'ok':'err'); setTimeout(()=>{ resp.style.display='none'; }, 4200); }

/******** toolbar *********/
toolbar.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  if(btn.dataset.md){ wrapSelection(content, ...btn.dataset.md.split('|')); queueRender(); return; }
  if(btn.dataset.link){ wrapSelection(content,'[','](https://)'); queueRender(); return; }
});
function wrapSelection(t, pre, post){ const s=t.selectionStart, e=t.selectionEnd, v=t.value; t.value=v.slice(0,s)+pre+v.slice(s,e)+post+v.slice(e); const d=pre.length; t.setSelectionRange(s+d,e+d); t.focus(); }

/******** preview (throttled) *********/
let renderQueued=false;
function queueRender(){ if(renderQueued) return; renderQueued=true; requestAnimationFrame(()=>{ renderQueued=false; renderPreview(); }); }
[username,avatarURL,content].forEach(el=> el.addEventListener('input', queueRender));

function renderPreview(){
  const name=esc(username.value||'Webhook'); const avatar=esc(avatarURL.value||'https://cdn.discordapp.com/embed/avatars/0.png'); const msg=esc(content.value||'');
  const n=(content.value||'').length; contentCount.textContent=`${n} / 2000`; contentCount.style.color = n>2000 ? '#fecaca' : '#cbd5e1';
  let html=`<div class="msg"><img class="avatar" src="${avatar}" alt="avatar"/><div><div class="name">${esc(name)}</div><div style="margin-top:6px;white-space:pre-wrap">${msg}</div></div></div>`;
  if(msgImages.length){ html += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">` + msgImages.map(u=>`<img class="thumb" src="${esc(u)}" alt="image"/>`).join('') + `</div>`; }
  embeds.forEach(e=>{
    const color=e.color||'#5865f2';
    const imgSrc = e._urlCache?.img || (e._imageFile ? (e._urlCache={...e._urlCache, img:URL.createObjectURL(e._imageFile)}, e._urlCache.img) : e.image || '');
    const thSrc  = e._urlCache?.th  || (e._thumbFile ? (e._urlCache={...e._urlCache, th:URL.createObjectURL(e._thumbFile)}, e._urlCache.th) : e.thumb || '');
    html+=`<div class="embed" style="border-color:${esc(color)}">`+
      (e.title?`<div style="font-weight:800">${esc(e.title)}</div>`:'')+
      (e.description?`<div style="margin-top:6px;white-space:pre-wrap">${esc(e.description)}</div>`:'')+
      (imgSrc?`<div style="margin-top:8px"><img src="${esc(imgSrc)}" class="thumb" style="width:auto;height:120px" alt="embed image"></div>`:'')+
      (thSrc?`<div style="margin-top:8px"><img src="${esc(thSrc)}" class="thumb" alt="thumbnail"></div>`:'')+
      (Array.isArray(e.fields)&&e.fields.length? `<div style="margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px">${e.fields.map(f=>`<div style="background:#ffffff10;border:1px solid #ffffff22;border-radius:8px;padding:6px"><div style="font-weight:800">${esc(f.name||'')}</div><div style="white-space:pre-wrap">${esc(f.value||'')}</div></div>`).join('')}</div>`:'')+
      (e.footer?`<div style="margin-top:8px;font-size:12px;opacity:.8">${esc(e.footer)}</div>`:'')+
      `</div>`;
  });
  preview.innerHTML=html;
}
renderPreview();

/******** images via link *********/
function renderImages(){ imageList.innerHTML = msgImages.map((u,i)=>`<span class="pill"><span>${esc(u)}</span><button data-rm="${i}">×</button></span>`).join(''); imageList.querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click',()=>{ msgImages.splice(parseInt(b.dataset.rm,10),1); renderImages(); queueRender(); })); imageThumbs.innerHTML = msgImages.map(u=>`<img class="thumb" src="${esc(u)}" alt="img">`).join(''); }
addImageBtn?.addEventListener('click',()=>{ const u=imageInput.value.trim(); if(!u) return; if(!validUrl(u)) return showResp('Invalid image URL', false); if(msgImages.length>=10) return showResp('Max 10 images', false); msgImages.push(u); imageInput.value=''; renderImages(); queueRender(); });

/******** files (DnD) *********/
function renderFiles(){ fileGrid.innerHTML = files.map((f,i)=>{ const isImg = /^image\//.test(f.type); const url = isImg ? URL.createObjectURL(f) : ''; return `<div class="file-card">${isImg?`<img src="${url}" alt="${esc(f.name)}"/>`:`<div style="height:96px;display:flex;align-items:center;justify-content:center;">${esc(f.type||'file')}</div>`}<div class="name">${esc(f.name)}</div><button data-rm="${i}">Remove</button></div>`; }).join(''); fileGrid.querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click',()=>{ files.splice(parseInt(b.dataset.rm,10),1); renderFiles(); })); }
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev,e=>{ e.preventDefault(); drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev,e=>{ e.preventDefault(); if(ev==='drop'){ files.push(...Array.from(e.dataTransfer.files||[])); renderFiles(); } drop.classList.remove('drag'); }));
fileInput.addEventListener('change',()=>{ files.push(...Array.from(fileInput.files||[])); fileInput.value=''; renderFiles(); });

/******** embeds + fields + file attachments *********/
function renderFieldRow(embedIndex, fieldIndex, container){
  const f = embeds[embedIndex].fields[fieldIndex];
  const row = document.createElement('div');
  row.className = 'field-item';
  row.innerHTML = `
    <input type="text" placeholder="Field name" value="${esc(f.name||'')}">
    <input type="text" placeholder="Field value" value="${esc(f.value||'')}">
    <div class="mini">
      <label><input type="checkbox" ${f.inline?'checked':''}> inline</label>
      <button class="btn-alt" data-clear>Clear</button>
    </div>
    <div class="field-actions">
      <button class="btn-alt" data-up>↑</button>
      <button class="btn-alt" data-down>↓</button>
      <button class="btn-alt" data-del>✖</button>
    </div>
  `;
  const [nameEl, valueEl] = row.querySelectorAll('input[type="text"]');
  const inlineEl = row.querySelector('input[type="checkbox"]');

  nameEl.addEventListener('input', ()=>{ embeds[embedIndex].fields[fieldIndex].name = nameEl.value; queueRender(); });
  valueEl.addEventListener('input', ()=>{ embeds[embedIndex].fields[fieldIndex].value = valueEl.value; queueRender(); });
  inlineEl.addEventListener('change', ()=>{ embeds[embedIndex].fields[fieldIndex].inline = inlineEl.checked; queueRender(); });
  row.querySelector('[data-clear]').addEventListener('click', ()=>{ embeds[embedIndex].fields[fieldIndex].name=''; embeds[embedIndex].fields[fieldIndex].value=''; nameEl.value=''; valueEl.value=''; queueRender(); });

  row.querySelector('[data-up]').addEventListener('click', ()=>{
    if(fieldIndex<=0) return; const arr=embeds[embedIndex].fields;
    [arr[fieldIndex-1], arr[fieldIndex]] = [arr[fieldIndex], arr[fieldIndex-1]];
    renderFields(embedIndex, container); queueRender();
  });
  row.querySelector('[data-down]').addEventListener('click', ()=>{
    const arr=embeds[embedIndex].fields; if(fieldIndex>=arr.length-1) return;
    [arr[fieldIndex+1], arr[fieldIndex]] = [arr[fieldIndex], arr[fieldIndex+1]];
    renderFields(embedIndex, container); queueRender();
  });
  row.querySelector('[data-del]').addEventListener('click', ()=>{
    embeds[embedIndex].fields.splice(fieldIndex,1); renderFields(embedIndex, container); queueRender();
  });
  container.appendChild(row);
}
function renderFields(embedIndex, container){ container.innerHTML = ''; embeds[embedIndex].fields.forEach((_,i)=> renderFieldRow(embedIndex, i, container)); }

function addEmbed(pre={}){
  const data={ title:pre.title||'', description:pre.description||'', color:pre.color||'#5865f2', footer:pre.footer||'', image:pre.image||'', thumb:pre.thumb||'', fields:Array.isArray(pre.fields)? pre.fields.map(f=>({name:f.name||'', value:f.value||'', inline:!!f.inline})) : [], _imageFile:null, _thumbFile:null, _urlCache:{} };
  embeds.push(data); const idx=embeds.length-1;

  const wrap=document.createElement('div'); wrap.className='embed-card';
  wrap.innerHTML=`
    <label>Title</label><input type="text" value="${esc(data.title)}" data-i="${idx}" data-f="title">
    <label>Description</label><textarea data-i="${idx}" data-f="description">${esc(data.description)}</textarea>

    <div class="twocol" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <div><label>Color</label><input type="color" value="${data.color}" data-i="${idx}" data-f="color"></div>
      <div><label>Footer</label><input type="text" placeholder="Footer text" value="${esc(data.footer)}" data-i="${idx}" data-f="footer"></div>
    </div>

    <label>Image URL</label><input type="url" placeholder="https://…" value="${esc(data.image)}" data-i="${idx}" data-f="image">
    <label>Thumbnail URL</label><input type="url" placeholder="https://…" value="${esc(data.thumb)}" data-i="${idx}" data-f="thumb">

    <div class="twocol" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px">
      <div><label>Embed Image (file)</label><input type="file" accept="image/*" data-i="${idx}" data-fx="imgfile"></div>
      <div><label>Embed Thumbnail (file)</label><input type="file" accept="image/*" data-i="${idx}" data-fx="thumbfile"></div>
    </div>

    <hr style="margin:10px 0; border:none; height:1px; background:#ffffff22">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <strong>Fields</strong>
      <div style="display:flex;gap:8px">
        <button class="btn-alt" data-addfield="${idx}">Add Field</button>
        <button class="btn-alt" data-clearall="${idx}">Clear All</button>
      </div>
    </div>
    <div class="field-list" data-fl="${idx}"></div>

    <div style="margin-top:8px"><button class="btn-alt" data-remove="${idx}">Remove Embed</button></div>
  `;
  embedsEl.appendChild(wrap);

  wrap.querySelectorAll('input[type="text"],input[type="url"],input[type="color"],textarea').forEach(inp=>{
    if(inp.dataset.f){ inp.addEventListener('input', ()=>{ embeds[inp.dataset.i][inp.dataset.f]=inp.value; queueRender(); }); }
  });
  wrap.querySelectorAll('input[type="file"][data-fx]').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const i=parseInt(inp.dataset.i,10);
      const f=(inp.files && inp.files[0])? inp.files[0]: null;
      if(inp.dataset.fx==='imgfile'){ embeds[i]._imageFile=f; embeds[i]._urlCache.img && URL.revokeObjectURL(embeds[i]._urlCache.img); embeds[i]._urlCache.img=null; }
      if(inp.dataset.fx==='thumbfile'){ embeds[i]._thumbFile=f; embeds[i]._urlCache.th && URL.revokeObjectURL(embeds[i]._urlCache.th); embeds[i]._urlCache.th=null; }
      queueRender();
    });
  });

  const listEl = wrap.querySelector('[data-fl]');
  renderFields(idx, listEl);
  wrap.querySelector('[data-addfield]').addEventListener('click', ()=>{ embeds[idx].fields.push({name:'',value:'',inline:false}); renderFields(idx, listEl); queueRender(); });
  wrap.querySelector('[data-clearall]').addEventListener('click', ()=>{ embeds[idx].fields=[]; renderFields(idx, listEl); queueRender(); });
  wrap.querySelector('[data-remove]').addEventListener('click', ()=>{ embeds.splice(idx,1); wrap.remove(); queueRender(); });
  queueRender();
}
addEmbedBtn?.addEventListener('click', ()=> addEmbed());

/******** payload + attachments (MULTI-FILE send) *********/
function parseIds(s){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); }
function filenameSafe(name){ return (name||'file').replace(/[^\w\-.]+/g,'_').slice(0,120) || 'file'; }
function buildEmbedsAndAttachments(){
  const built=[]; const attachments=[];
  embeds.forEach((e,i)=>{
    const out={};
    if(e.title) out.title=e.title;
    if(e.description) out.description=e.description;
    if(e.color) out.color=parseInt(e.color.replace('#',''),16);
    if(e.footer) out.footer={text:e.footer};
    if(Array.isArray(e.fields)&&e.fields.length){
      const cleaned=e.fields.map(f=>({name:f.name||'', value:f.value||'', inline:!!f.inline}))
        .filter(f=>(f.name||'').trim()||(f.value||'').trim());
      if(cleaned.length) out.fields=cleaned;
    }
    if(e._imageFile){ const fname=filenameSafe(`embed${i+1}-image-${e._imageFile.name||'img'}`); attachments.push({file:e._imageFile,name:fname, ref:'image'}); out.image={url:`attachment://${fname}`}; }
    else if((e.image||'').trim()){ out.image={url:e.image.trim()}; }
    if(e._thumbFile){ const fname=filenameSafe(`embed${i+1}-thumb-${e._thumbFile.name||'thumb'}`); attachments.push({file:e._thumbFile,name:fname, ref:'thumb'}); out.thumbnail={url:`attachment://${fname}`}; }
    else if((e.thumb||'').trim()){ out.thumbnail={url:e.thumb.trim()}; }
    if(Object.keys(out).length) built.push(out);
  });
  msgImages.forEach(u=>{ if(built.length<10) built.push({ image:{ url:u } }); });
  return { embeds: built.slice(0,10), attachments };
}
function buildAllowedMentions(){ const roles=parseIds(mentionRoles.value), users=parseIds(mentionUsers.value); const parse=[]; if(mentionEveryone?.checked||mentionHere?.checked) parse.push('everyone'); return { parse, roles, users }; }
function buildPayloadAndAttachments(){
  const p={}; let c=(content.value||'').trim();
  if(mentionEveryone?.checked) c=`@everyone ${c}`; if(mentionHere?.checked) c=`@here ${c}`;
  if(c) p.content=c; if(username.value) p.username=username.value; if(avatarURL.value) p.avatar_url=avatarURL.value;
  const {embeds: em, attachments: embedAtts}=buildEmbedsAndAttachments(); if(em.length) p.embeds=em;
  const am=buildAllowedMentions(); if(am.parse.length||am.roles.length||am.users.length) p.allowed_mentions=am;
  return { payload:p, embedAttachments: embedAtts };
}

/******** history (de-duplicated, to reduce lag) *********/
function payloadKey(webhook, payload){ return webhook + '|' + JSON.stringify(payload, Object.keys(payload).sort()); }
function getHistory(){ try{ return JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); }catch{ return []; } }
function setHistory(list){ try{ localStorage.setItem(HIST_KEY, JSON.stringify(list.slice(0,100))); }catch{} }
function pushHistory(entry){
  const list=getHistory(); const key=payloadKey(entry.webhook, entry.payload);
  const idx=list.findIndex(x=> payloadKey(x.webhook,x.payload)===key);
  if(idx>=0){ list.splice(idx,1); }
  list.unshift(entry); setHistory(list); renderHistory();
}
function renderHistory(){
  const list=getHistory();
  historyList.innerHTML = list.length? list.map((h,i)=>`
    <div class="row"><div><strong>#${i+1}</strong> — ${new Date(h.ts).toLocaleString()}</div>
      <div class="acts">
        <button class="btn-alt" data-load="${i}">Load</button>
        <button class="btn-alt" data-resend="${i}">Re-send</button>
      </div></div>`).join('') : 'No history yet.';
  historyList.querySelectorAll('[data-load]').forEach(b=> b.addEventListener('click',()=>{
    const h=getHistory()[parseInt(b.dataset.load,10)]; if(!h) return;
    username.value=h.payload.username||''; avatarURL.value=h.payload.avatar_url||''; content.value=h.payload.content||'';
    embeds=(h.payload.embeds||[]).map(e=>({ title:e.title||'', description:e.description||'', color:e.color?('#'+(e.color>>>0).toString(16).padStart(6,'0')):'#5865f2', footer:e.footer?.text||'', image:e.image?.url||'', thumb:e.thumbnail?.url||'', fields:Array.isArray(e.fields)? e.fields.map(f=>({name:f.name||'', value:f.value||'', inline:!!f.inline})) : [], _imageFile:null, _thumbFile:null, _urlCache:{} }));
    embedsEl.innerHTML=''; embeds.forEach(e=> addEmbed(e)); queueRender();
    closeHistoryModal();
    tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab==='message')); Object.values(panels).forEach(p=> p.classList.remove('active')); panels.message.classList.add('active');
  }));
  historyList.querySelectorAll('[data-resend]').forEach(b=> b.addEventListener('click',async()=>{
    const h=getHistory()[parseInt(b.dataset.resend,10)]; if(!h) return; try{
      const r=await fetch(h.webhook,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(h.payload)}); showResp(r.ok?'Re-sent':'Re-send failed', r.ok);
    }catch(e){ showResp('Network error: '+e.message,false); }
  }));
}
function clearHistoryData(){ localStorage.removeItem(HIST_KEY); renderHistory(); }

/******** modal open/close *********/
function openHistoryModal(){ historyBackdrop.style.display='block'; historyModal.style.display='block'; renderHistory(); }
function closeHistoryModal(){ historyBackdrop.style.display='none'; historyModal.style.display='none'; }
historyBtn.addEventListener('click', openHistoryModal);
closeHistory.addEventListener('click', closeHistoryModal);
historyBackdrop.addEventListener('click', closeHistoryModal);
clearHistory.addEventListener('click', clearHistoryData);

/******** send *********/
function parseWebhookList(){ const list=[]; const main=webhookURL.value.trim(); if(main) list.push(main); (webhookExtra.value||'').split('\n').map(s=>s.trim()).filter(Boolean).forEach(u=> list.push(u)); return [...new Set(list)]; }
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

/* Build final file list & send as files[0..N] with payload.attachments */
function filenameOnly(name){ return (name||'file').split('/').pop(); }

async function sendToWebhook(url, payloadObj, allFiles){
  const form=new FormData();

  // map files to files[0], files[1], ... and set attachments metadata
  allFiles.forEach((att, i) => {
    form.append(`files[${i}]`, att.file, att.name);
  });
  if(allFiles.length){
    payloadObj.attachments = allFiles.map((att,i)=>({ id:i, filename:att.name || filenameOnly(att.file?.name) || `file_${i}` }));
  }

  form.append('payload_json', JSON.stringify(payloadObj));
  const r = await fetch(url,{ method:'POST', body: form });
  if(r.status===429){
    let retry=900; try{ const j=await r.json(); if(j.retry_after) retry=Math.ceil(Number(j.retry_after)*1000);}catch{}
    await sleep(retry); return sendToWebhook(url, payloadObj, allFiles);
  }
  return r;
}

async function sendPayload(){
  const urls=parseWebhookList(); if(!urls.length) return showResp('Enter at least one webhook URL', false);

  const { payload, embedAttachments } = buildPayloadAndAttachments();

  // Combine: embed-attached images/thumbnails + message-level arbitrary files
  const messageFiles = files.map(f => ({ file:f, name: filenameSafe(f.name||'file') }));
  const allFiles = [...embedAttachments, ...messageFiles];

  const hasAny = allFiles.length || payload.content || (payload.embeds && payload.embeds.length);
  if(!hasAny) return showResp('Add message or attachments before sending.', false);

  let ok=0, fail=0;
  for(let i=0;i<urls.length;i++){
    try{
      const r=await sendToWebhook(urls[i], {...payload}, allFiles);
      const okNow=r.ok; ok+=okNow?1:0; fail+=okNow?0:1;
      if(okNow) pushHistory({ ts: Date.now(), webhook:urls[i], payload });
    }catch{ fail++; }
    if(i<urls.length-1) await sleep(200);
  }
  showResp(ok && !fail ? `Sent (${ok}/${urls.length})` : ok ? `Partial (${ok}/${urls.length})` : 'Failed', !!ok);
  if(ok){ files=[]; renderFiles(); }
}
fabSend?.addEventListener('click', sendPayload);

/******** CLEAR FORM *********/
function clearForm(){
  if(!confirm('Clear message form? (webhook URLs are kept)')) return;
  username.value=''; avatarURL.value=''; content.value='';
  mentionEveryone.checked=false; mentionHere.checked=false;
  mentionRoles.value=''; mentionUsers.value='';
  msgImages.length=0; imageInput.value=''; imageList.innerHTML=''; imageThumbs.innerHTML='';
  files.length=0; fileInput.value=''; renderFiles();
  embeds.length=0; embedsEl.innerHTML='';
  queueRender();
}
fabClear?.addEventListener('click', clearForm);

/******** init *********/
(function init(){
  imageList.innerHTML=''; imageThumbs.innerHTML='';
  renderFiles(); renderPreview(); renderHistory();
})();
</script>
</body>
</html>
